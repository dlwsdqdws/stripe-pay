<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apple Pay æµ‹è¯•</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 { color: #333; margin-bottom: 10px; }
        .subtitle { color: #666; margin-bottom: 30px; font-size: 14px; }
        .input-group { margin-bottom: 20px; }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }
        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4); }
        button:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .result {
            margin-top: 20px;
            padding: 16px;
            border-radius: 8px;
            font-size: 14px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        #apple-pay-button {
            width: 100%;
            height: 50px;
            margin-top: 20px;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ Apple Pay æµ‹è¯•</h1>
        <p class="subtitle">ä½¿ç”¨ Stripe æ¥å…¥ Apple Pay</p>
        
        <!-- é‡‘é¢ä¸å¸ç§ç”±åç«¯å®šä»·ï¼Œè¿™é‡Œä¸å†è¾“å…¥ -->
        
        <div class="input-group">
            <label>ç”¨æˆ·ID <span style="color:red;">*</span></label>
            <input type="text" id="userId" value="" placeholder="è¯·è¾“å…¥ç”¨æˆ·ID" required>
        </div>
        
        <div class="input-group">
            <label>æè¿°</label>
            <input type="text" id="description" value="Apple Pay æµ‹è¯•æ”¯ä»˜" placeholder="æ”¯ä»˜æè¿°">
        </div>
        
        <button onclick="createPayment()" id="createBtn">åˆ›å»ºæ”¯ä»˜</button>
        
        <div id="apple-pay-container"></div>
        
        <div id="result"></div>
    </div>

    <script>
        // âš ï¸ æ›¿æ¢ä¸ºä½ çš„ Stripe å…¬é’¥
        const STRIPE_PUBLIC_KEY = 'pk_test_51SMmu26xpYAaGcYpdjESKiAK2RPFkhLArDeyaM32TI7okwSB3RLxRRCQF1ydYLgKcRM5TBu7OSHXZMOUvSEwyVVD002pIk0KkT';
        // ä½¿ç”¨ä¸å½“å‰é¡µé¢ç›¸åŒçš„åŸŸåï¼ˆngrok 8080 åŸŸåï¼‰
        const API_URL = window.location.origin;
        
        const stripe = Stripe(STRIPE_PUBLIC_KEY);
        let paymentRequest = null;
        let clientSecret = null;
        let paymentIntentId = null;

        async function createPayment() {
            // ä»·æ ¼ä¸å¸ç§ç”±åç«¯æ§åˆ¶
            const description = document.getElementById('description').value || 'Apple Pay æµ‹è¯•';
            
            const btn = document.getElementById('createBtn');
            const resultDiv = document.getElementById('result');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> å¤„ç†ä¸­...';
            resultDiv.innerHTML = '';
            
            try {
                // è·å–å®šä»·
                const pResp = await fetch(`${API_URL}/api/v1/pricing`);
                const pricing = await pResp.json();
                if (!pResp.ok) throw new Error('è·å–å®šä»·å¤±è´¥');

                // è·å–ç”¨æˆ·IDï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                const userIdInput = document.getElementById('userId');
                const userId = userIdInput ? userIdInput.value.trim() : '';
                
                if (!userId) {
                    throw new Error('è¯·è¾“å…¥ç”¨æˆ·ID');
                }
                
                // åˆ›å»ºæ”¯ä»˜
                const response = await fetch(`${API_URL}/api/v1/stripe/create-payment`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ user_id: userId, description })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(JSON.stringify(data));
                }
                
                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç»æ”¯ä»˜è¿‡
                if (data.already_paid) {
                    const userInfo = data.user_info || {};
                    const daysRemaining = data.days_remaining !== undefined ? data.days_remaining : 'N/A';
                    resultDiv.innerHTML = `<div class="success">
                        âœ… <strong>ç”¨æˆ·å·²æ”¯ä»˜æˆåŠŸ</strong><br><br>
                        <strong>æ”¯ä»˜ä¿¡æ¯ï¼š</strong><br>
                        â€¢ ç”¨æˆ·ID: ${userId}<br>
                        â€¢ æ”¯ä»˜æ¬¡æ•°: ${userInfo.total_payment_count || 0}<br>
                        â€¢ æ€»æ”¯ä»˜é‡‘é¢: HK$${((userInfo.total_payment_amount || 0) / 100).toFixed(2)}<br>
                        â€¢ é¦–æ¬¡æ”¯ä»˜æ—¶é—´: ${userInfo.first_payment_at ? new Date(userInfo.first_payment_at).toLocaleString() : 'N/A'}<br>
                        â€¢ æœ€åæ”¯ä»˜æ—¶é—´: ${userInfo.last_payment_at ? new Date(userInfo.last_payment_at).toLocaleString() : 'N/A'}<br>
                        â€¢ å‰©ä½™æœ‰æ•ˆå¤©æ•°: ${daysRemaining} å¤©<br><br>
                        <strong>${data.message || 'æ— éœ€é‡å¤æ”¯ä»˜'}</strong>
                    </div>`;
                    btn.disabled = false;
                    btn.innerHTML = 'åˆ›å»ºæ”¯ä»˜';
                    return;
                }
                
                clientSecret = data.client_secret;
                paymentIntentId = data.payment_intent_id;
                
                // åˆ›å»º Payment Request ç”¨äº Apple Pay
                paymentRequest = stripe.paymentRequest({
                    country: 'HK',
                    currency: pricing.currency,
                    total: { label: pricing.label, amount: pricing.amount },
                    requestPayerName: true,
                    requestPayerEmail: true,
                });
                
                // æ£€æŸ¥æ˜¯å¦æ”¯æŒ Apple Pay
                const canMakePayment = await paymentRequest.canMakePayment();
                
                if (canMakePayment && canMakePayment.applePay) {
                    const elements = stripe.elements();
                    const paymentRequestButton = elements.create('paymentRequestButton', {
                        paymentRequest,
                        style: {
                            paymentRequestButton: {
                                theme: 'dark',
                                height: '50px',
                            },
                        },
                    });
                    
                    paymentRequestButton.mount('#apple-pay-button');
                    
                    resultDiv.innerHTML = `<div class="success">
                        âœ… <strong>æ”¯ä»˜å·²åˆ›å»ºæˆåŠŸ</strong><br>
                        Payment Intent ID: ${paymentIntentId}<br>
                        Client Secret: ${clientSecret.substring(0, 30)}...<br><br>
                        ğŸ Apple Pay æŒ‰é’®å·²æ˜¾ç¤ºï¼Œç‚¹å‡»ä½¿ç”¨ Apple Pay æ”¯ä»˜
                    </div>`;
                } else {
                    resultDiv.innerHTML = `<div class="info">
                        âš ï¸ <strong>ä¸æ”¯æŒ Apple Pay</strong><br>
                        è¯·ç¡®ä¿ï¼š<br>
                        1. ä½¿ç”¨ Safari æµè§ˆå™¨<br>
                        2. å·²åœ¨ Stripe Dashboard æ·»åŠ åŸŸå<br>
                        3. è®¾å¤‡å·²é…ç½® Apple Payï¼ˆmacOS/iOSï¼‰
                    </div>`;
                }
                
                // å¤„ç†æ”¯ä»˜
                paymentRequest.on('paymentmethod', async (ev) => {
                    const {error} = await stripe.confirmCardPayment(
                        clientSecret,
                        {payment_method: ev.paymentMethod.id},
                        {handleActions: false}
                    );
                    
                    if (error) {
                        ev.complete('fail');
                        resultDiv.innerHTML = `<div class="error">
                            âŒ <strong>æ”¯ä»˜å¤±è´¥</strong><br>
                            é”™è¯¯: ${error.message}
                        </div>`;
                    } else {
                        ev.complete('success');
                        resultDiv.innerHTML = `<div class="success">
                        ğŸ‰ <strong>æ”¯ä»˜æˆåŠŸï¼</strong><br><br>
                            Payment Intent ID: <code>${paymentIntentId}</code><br>
                            çŠ¶æ€: succeeded<br>
                        é‡‘é¢: ä»¥æœåŠ¡å™¨å®šä»·ä¸ºå‡†
                        </div>`;
                    }
                });
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">
                    âŒ <strong>å‘ç”Ÿé”™è¯¯</strong><br>
                    ${error.message}
                </div>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'åˆ›å»ºæ”¯ä»˜';
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åˆ›å»ºæ”¯ä»˜
        window.onload = () => {
            setTimeout(createPayment, 500);
        };
    </script>
</body>
</html>
